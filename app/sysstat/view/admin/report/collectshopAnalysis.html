<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>charts</title>
  <meta name="description" content="Highcharts" />
    <{css src="jquery.datetimepicker.css" app="sysstat"}>
    <{css src="sysstat-analysis.css" app="sysstat"}>
    <{css src="framework.css" app="desktop"}>
    <{script src="jquery.js" app="sysstat"}>
    <{script src="jquery.datetimepicker.js" app="sysstat"}>
</head>

<body>
   <div class="notice">收藏量为用户执行收藏次数的累计数据，不包含取消收藏次数</div>
    <div class="gridlist-action data-action" id="dataAction">
      <table width="100%" cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td <{if $report_type}>align="right"<{/if}> nowrap="nowrap">
            <label><{t}>时间范围:<{/t}></label>
            <input class="x-input cal datetimepicker" readonly="readonly" type="text" value="<{$time_start}>" id="time_from" name="time_from">
             至
            <input class="x-input cal datetimepicker" type="text" value="<{$time_end}>" id="time_end" name="time_end">
           <button id="confirmBtn" type="button" ><span><span>确定</span></span></button>
           <button class="btn dataBtn  btn-fourthly" value="yesterday" type="button"><span><span>昨日</span></span></button>
           <button class="btn dataBtn  btn-fourthly" value="beforeday" type="button"><span><span>前日</span></span></button>
           <button class="btn dataBtn btn-fourthly"  value="week" type="button"><span><span>最近七天</span></span></button>
           <button class="btn dataBtn btn-fourthly"  value="month" type="button"><span><span>最近30天</span></span></button>
           <select id="storeListFrom" class="trade-select">
            <option value="5">前五名</option>
            <option value="10">前十名</option>
            <option value="20">前二十名</option>
           </select>

          </td>
          <td class="txt-right w90"><div class="browse-old-data"><a href="?app=sysstat&ctl=admin_collectionshop&act=dataShow" target="_parent" class="btn old-data">浏览原始数据</a><span>»</span></div></td>
        </tr>
      </table>
    </div>
    <script type="text/javascript">
    $('.datetimepicker').datetimepicker({
        lang:"ch",
        format:"Y-m-d"
    });
    </script>
    <div class="data-tabs">
        <ul>
            <li class="current"><a href="javascript:void(0);" data-param="num" >店铺收藏量排行</a></li>
        </ul>
        <div class="clear"></div>
    </div>
    <div id="container" class="table-content">
        <table>
            <thead>
                <tr>
                    <th class="td-1">店铺排名</th>
                    <th>店铺名称</th>
                    <th>店铺收藏量</th>
                </tr>
            </thead>
            <tbody id='sss' class="table-tbody">
                <{if $collectShopData}>
                    <{foreach from=$collectShopData item=shopList}>
                    <tr>
                        <td class="td-1"><span><{assign var="i" value=$i+1}><{$i}></span></td>
                        <td class="td-2">
                            <div class="analysis-goods">
                                <a href="<{$shopList.shopurl}>" target="_blank">
                                    <{$shopList.shopname}>
                                </a>
                            </div>
                        </td>
                        <td class="td-5 td-ranking"><{$shopList.collectnum}></td>

                    </tr>
                    <{/foreach}>
                <{else}>
                    <tr>
                        <td colspan="5">
                        暂无数据
                        </td>
                    </tr>
                <{/if}>
            </tbody>
        </table>
    </div>
</body>
<script>
    $(function () {

        $('#confirmBtn').click(function(){
            loadData();
        });
        $('.data-tabs li a').click(function() {
            $(this).parent().addClass('current').siblings().removeClass('current');
            loadData();
        });
        $('#storeListFrom').change(function() {
            loadData();
        });

        function loadData(){
            var dataType = $('li.current').children('a').attr('data-param')?$('li.current').children('a').attr('data-param'):'num';
            var timeFrom = $("#time_from").val()+' 00.00.00';
            var timeEnd = $("#time_end").val()+' 23.59.59';
            var storeLimit = $('#storeListFrom').val()?$('#storeListFrom').val():'5';
            var catId = $('#catName').val()?$('#catName').val():'all';
            var htmlstr = '';

            var url='?app=sysstat&ctl=admin_collectionshop&act=ajaxData'
            var postdata='time_start='+timeFrom+'&time_end='+timeEnd+'&dataType='+dataType+'&storeLimit='+storeLimit;

            $.post(url,postdata,function(data){
                if(data.error)
                {
                    alert(data.error);
                }

                var top_1 = 0;
                var bar_width = 0;
                console.log(data.collectShopData);
                for (var i = 0; i <= data.collectShopData.length - 1; i++)
                {
                    var isdisplay = '';
                    top_1 = data.collectShopData[0].collectnum;
                    isdisplay = data.collectShopData[i].collectnum;

                    bar_width = i > 0 ? (isdisplay/top_1)*100*0.8: 80;
                    if(i < 3) {
                        htmlstr+='<tr><td class="td-1"><span>'+(i+1)+'</span></td><td class="td-2"><div class="analysis-goods"><a href='+data.collectShopData[i].shopurl+' target=_blank>'+data.collectShopData[i].shopname+'</a></div></td><td class="td-5 td-ranking"><div><i class="icon top"></i><span class="ranking-bar top" style="width:'+bar_width+'%;"></span><span class="ranking-num">'+ isdisplay +'</span></div></td></tr>';
                    }else {
                         htmlstr+='<tr><td class="td-1 top-default"><span>'+(i+1)+'</span></td><td class="td-2"><div class="analysis-goods"><a href='+data.collectShopData[i].shopurl+' target=_blank>'+data.collectShopData[i].shopname+'</a></div></td><td class="td-5 td-ranking"><div><i class="icon"></i><span class="ranking-bar" style="width:'+bar_width+'%;"></span><span class="ranking-num">'+ isdisplay +'</span></div></td></tr>';
                    }
                };
                if(data.collectShopData.length==0)
                {
                    htmlstr = '<tr><td colspan="5">暂无数据</td></tr>';
                }
                $('#container #sss').html(htmlstr);
            });
        }
        $('.dataBtn').click(function(){
            var dataType = $(this).attr('data-param')?$(this).attr('data-param'):'num';
            var timeType = $(this).attr("value");
            var storeLimit = $('#storeListFrom').val()?$('#storeListFrom').val():'5';
            var htmlstr = '';
            var url='?app=sysstat&ctl=admin_collectionshop&act=ajaxTimeData';
            var postdata='timeType='+timeType+'&dataType='+dataType+'&storeLimit='+storeLimit;

            $.post(url,postdata,function(data){
                if(data.error)
                {
                    alert(data.error);
                }
                $("#time_from").val(data.time_start);
                $("#time_end").val(data.time_end);
                var top_1 = 0;
                var bar_width = 0;

                for (var i = 0; i <= data.collectShopData.length - 1; i++)
                {
                    var isdisplay = '';
                    top_1 = data.collectShopData[0].collectnum;
                    isdisplay = data.collectShopData[i].collectnum;
                    bar_width = i > 0 ? (isdisplay/top_1)*100*0.8: 80;
                    if(i < 3) {
                        htmlstr+='<tr><td class="td-1"><span>'+(i+1)+'</span></td><td class="td-2"><div class="analysis-goods"><a href='+data.collectShopData[i].shopurl+' target=_blank>'+data.collectShopData[i].shopname+'</a></div></td><td class="td-5 td-ranking"><div><i class="icon top"></i><span class="ranking-bar top" style="width:'+bar_width+'%;"></span><span class="ranking-num">'+ isdisplay +'</span></div></td></tr>';
                    }else {
                         htmlstr+='<tr><td class="td-1 top-default"><span>'+(i+1)+'</span></td><td class="td-2"><div class="analysis-goods"><a href='+data.collectShopData[i].shopurl+' target=_blank> '+data.collectShopData[i].shopname+'</a></div></td><td class="td-5 td-ranking"><div><i class="icon"></i><span class="ranking-bar" style="width:'+bar_width+'%;"></span><span class="ranking-num">'+ isdisplay +'</span></div></td></tr>';
                    }
                };
                if(data.collectShopData.length==0)
                {
                    htmlstr = '<tr><td colspan="5">暂无数据</td></tr>';
                }
                $('#container').find('tbody').html(htmlstr);
            })
        })

        //初始化数据列表中的统计样式
        var td_ranking = $('.td-ranking');
        var number_one = 0;
        var ranking_bar_width = 0;
        for(var i = 0; i <= td_ranking.length; i++) {
            number_one = Number($(td_ranking[0]).find('.ranking-num').text());
            ranking_bar_width = i > 0 ? (Number($(td_ranking[i]).find('.ranking-num').text())/number_one)*100*0.8: 80;
            if(i < 3){
                $(td_ranking[i]).find('.icon').addClass('top');
                $(td_ranking[i]).find('.ranking-bar').addClass('top');
            } else {
                $(td_ranking[i]).siblings('.td-1').addClass('top-default');
            }
            $(td_ranking[i]).find('.ranking-bar').css('width', ranking_bar_width+"%");
        }
    });
  </script>
</html>
